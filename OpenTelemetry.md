# OpenTelemetry

开源的可观测性框架和标准集合，用于对分布式系统进行监控，追踪和诊断
主要遥测数据的生成，采集和管理：


### 三类可观测指标

`Metrics` 通常判断是否有异常，`Trace` 定位异常，`Log` 查询原因

- `Traces`
  - 分布式追踪
    - 一次请求在多个服务中的调用链路和耗时
- `Metrics`
  - 指标，记录系统运行状态
    - `QPS`
    - `CPU`
- `Logs`
  - 记录离散事件并和 `Trace` 进行关联

##### 指标采集

使用 `Prometheus`

##### 日志采集

日志一般使用 `Sidecar` 代理的方式通过 `Agent` 将数据写入 `ElasticSearch`

### 架构

- 客户端（应用）
  - 挂载 `agent` 将采集信息上传 `Collector`
- `Collector`
  - 接收客户端上传数据，内部处理，输出到存储系统
- 数据存储



##### Collector

`Receiver` 用于接收客户端上报数据，除了 `agent` 还支持其他第三方的

`Exporter` 将 `Receiver` 收到的数据进行处理之后输出到不同组件

> `https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver` 查看所有支持的第三方 `Receiver`

`Receiver` 和 `Exporter` 可以自由组合实现任何逻辑并且不会影响到业务本身

### 插桩

系统组件必须发出信号

- 使用 `API` 和 `SDK`
- 零代码
    - 无法修改数据只能提供应用边缘信息

##### 零代码

通常以代理或类似代理的方式安装，一般是为使用的库插桩

##### 基于代码

需要导入和配置 `API` 和 `SDK`，从程序中获取指标信息，通过进程或者代理发送数据

### 组件

##### Collector

一个和供应商无关的代理，可以接收，处理和导出遥测数据，可以将数据发送到一个或多个后端，并且支持导出之前的处理数据

##### API 和 SDK

##### 插桩库

##### 导出器

将数据发送到代理，确保其被正确导出，如果需要可视化，可将数据导出到可视化后端 `Jaeger`

##### 零代码插桩

底层取决于语言

##### 资源检测器

以资源属性表示生成遥测数据的实体，环境变量，容器名等

##### 跨服务传播器

用于跨服务和进程边界传递信息，一般情况下是使用上下文传播，也可以自定义传播器

##### 采集器

限制系统生成跟踪数量

##### Kubernetes Operator


### 资源

以资源属性的形式表示产生遥测数据的实体，`k8s` 中包含容器，命名空间等相关的信息
`Jaeger` 中资源属性会被归结于 `Process`

资源在初始化的时候被添加到 `TracerProvider` 或者 `MetricProvider` 一旦绑定无法更改
`SDK` 中会提供资源探测器，用于从环境中获取资源信息

### 采样

通过链路，可以观测请求在分布式系统中从一个服务传递到另一个服务，如果大部分请求没有问题则不需要 `100%` 链路数据，只需要正确的采样就行


[参考链接 https://opentelemetry.io/zh/docs/concepts/]
